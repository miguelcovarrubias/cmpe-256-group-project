{% extends 'layouts/main.html' %}
{% block title %}Spotify Recommendation System - Demo{% endblock %}
{% block content %}
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<div class="row d-flex justify-content-center">
  <div class="col-xl-8 col-lg-8 col-md-12 col-sm-12 col-12">
    <div class="input-group">
      <input id="search-field" type="text" class="form-control" placeholder="Paste a Playlist URL here!">
      <div class="input-group-append">
        <button id="search-button" class="btn button-green" type="button">
          <i class="fa fa-cogs"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="playlist-results">
</div>

<br>
<br>
<br>

<div id="input-playlist-template" class="d-none">
  <div class="header-div d-flex justify-content-center">
    <h3>This is the input playlist!</h3>
  </div>
  <div class="iframe-div d-flex justify-content-center">
    <iframe class="playlist-iframe" width="600" height="260" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
  </div>
  <div class="header-div d-flex justify-content-center">
    <h3>Here are the ranked recommendations!</h3>
  </div>
</div>

<div id="playlist-template" class="d-none">
  <div class="header-div d-flex justify-content-center">
    <h3 class="playlist-rank"></h3>
  </div>
  <div class="iframe-div d-flex justify-content-center">
    <iframe class="playlist-iframe" width="600" height="260" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
  </div>
</div>

<script type="text/javascript">
  // display the recommendation results
  var renderRecommendations = function(response){
    // append input playlist
    var template = $("#input-playlist-template").clone();
    template.attr("id", "input-playlist");
    template.removeClass("d-none");

    var playlistIframe = template.children(".iframe-div").children(".playlist-iframe");
    playlistIframe.attr("src",response.currentPlaylist);

    $('#playlist-results').append(template);

    // append playist recommendations
    response.playlists.forEach(function(playlist, i){
      var template = $("#playlist-template").clone();
      template.attr("id", "playlist-"+i);
      template.removeClass("d-none");

      var playlistHeader = template.children(".header-div").children(".playlist-rank");
      playlistHeader.text(playlist.playlistRanking);

      var playlistIframe = template.children(".iframe-div").children(".playlist-iframe");
      playlistIframe.attr("src",playlist.playlistUrl);

      $('#playlist-results').append(template);
    });
  }

  // Ajax call for submitting playlist recommendation request
  $('#search-button').on('click', function (e) {

    // remove currently displayed playlists
    $("#playlist-results").empty();

    playlistUrl = $('#search-field').val();
    var request_payload = {
      'playlist_url': playlistUrl
    }

    $.ajax({
      url: "{{url_for('search_api')}}",
      data: JSON.stringify(request_payload),
      type: 'POST',
      crossDomain: true,
      dataType: 'json',
      success: function(response) {
        console.log(response);
        renderRecommendations(response);
      },
      error: function(error) {
        console.log(error);
      },
    });

  });

</script>

{% endblock %}
